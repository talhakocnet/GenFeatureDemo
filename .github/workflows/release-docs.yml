
name: Release Docs & Changelog

permissions:
  contents: write
  pages: write
  id-token: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build-release-docs:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --verbosity normal

      - name: Generate OpenAPI (swagger) files
        shell: bash
        run: |
          mkdir -p docs/api

          dotnet tool install --global Swashbuckle.AspNetCore.Cli --version 6.5.0
          export PATH="$PATH:$HOME/.dotnet/tools"

          swagger tofile \
            --output docs/api/openapi.json \
            ./GenDemo/bin/Release/net10.0/GenDemo.dll \
            v1

          cat > docs/api/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>GenDemo API Docs</title>
            <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css" />
            <style>
              body { margin: 0; }
            </style>
          </head>
          <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
            <script>
              window.onload = () => {
                SwaggerUIBundle({
                  url: "./openapi.json",
                  dom_id: "#swagger-ui",
                  deepLinking: true,
                  presets: [SwaggerUIBundle.presets.apis],
                  layout: "BaseLayout"
                });
              };
            </script>
          </body>
          </html>
          HTML



      - name: Generate release-notes.md from commits
        id: release_notes
        run: |
          mkdir -p artifacts
          git fetch --tags --force
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
          if [ -z "$LAST_TAG" ]; then
            git log --no-merges --pretty=format:'%s' \
              --invert-grep --grep='chore: update CHANGELOG.md with latest release notes' \
              > artifacts/commits.txt
          else
            git log --no-merges --pretty=format:'%s' "$LAST_TAG..HEAD" \
              --invert-grep --grep='chore: update CHANGELOG.md with latest release notes' \
              > artifacts/commits.txt
          fi

          # Per-section bullet lists for inserting into CHANGELOG.md
          : > artifacts/added.md
          : > artifacts/changed.md
          : > artifacts/fixed.md
          : > artifacts/breaking.md
          # Turn commit subjects into readable bullets (strip prefixes, normalize punctuation)
          prettify() {
            sed -E "s/^(feat|fix|docs|chore|refactor|perf|style)(\([^)]*\))?(!)?:[[:space:]]*//I" | \
              sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//' | \
              sed -E '/[.!?]$/! s/$/./' | \
              sed -E 's/^./\u&/'
          }

          grep -iE '^feat(\(|!|:| )' artifacts/commits.txt | prettify | sed 's/^/- /' >> artifacts/added.md || true
          grep -iE '^(chore|refactor|perf|style|docs)(\(|!|:| )' artifacts/commits.txt | prettify | sed 's/^/- /' >> artifacts/changed.md || true
          grep -iE '^fix(\(|!|:| )' artifacts/commits.txt | prettify | sed 's/^/- /' >> artifacts/fixed.md || true
          grep -iE 'BREAKING CHANGE|!:' artifacts/commits.txt | prettify | sed 's/^/- /' >> artifacts/breaking.md || true

          # Human-readable artifact
          echo "# Release Notes" > artifacts/release-notes.md
          echo >> artifacts/release-notes.md
          echo "## Added" >> artifacts/release-notes.md
          cat artifacts/added.md >> artifacts/release-notes.md
          echo >> artifacts/release-notes.md
          echo "## Changed" >> artifacts/release-notes.md
          cat artifacts/changed.md >> artifacts/release-notes.md
          echo >> artifacts/release-notes.md
          echo "## Fixed" >> artifacts/release-notes.md
          cat artifacts/fixed.md >> artifacts/release-notes.md
          echo >> artifacts/release-notes.md
          echo "## Breaking Changes" >> artifacts/release-notes.md
          cat artifacts/breaking.md >> artifacts/release-notes.md

      - name: Insert release notes into CHANGELOG.md ([Unreleased])
        id: changelog
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            cp ./GenDemo/CHANGELOG.md artifacts/CHANGELOG.md
          python3 - <<'PY'
          from pathlib import Path

          changelog_path = Path('artifacts/CHANGELOG.md')
          text = changelog_path.read_text(encoding='utf-8')

          def read_lines(path: str):
            p = Path(path)
            if not p.exists():
              return []
            return [ln.rstrip('\n') for ln in p.read_text(encoding='utf-8').splitlines() if ln.strip()]

          sections_to_add = {
            '### Added': read_lines('artifacts/added.md'),
            '### Changed': read_lines('artifacts/changed.md'),
            '### Fixed': read_lines('artifacts/fixed.md'),
            '### Breaking Changes': read_lines('artifacts/breaking.md'),
          }

          lines = text.splitlines()
          # Find [Unreleased] block
          try:
            start = next(i for i,l in enumerate(lines) if l.strip() == '## [Unreleased]')
          except StopIteration:
            raise SystemExit('Missing "## [Unreleased]" header in CHANGELOG.md')
          end = next((i for i in range(start+1, len(lines)) if lines[i].startswith('## [')), len(lines))

          unreleased = lines[start:end]
          before = lines[:start]
          after = lines[end:]

          def inject(unreleased_lines, heading, new_bullets):
            if not new_bullets:
              return unreleased_lines
            out = []
            in_target = False
            existing = set()
            for ln in unreleased_lines:
              if ln.strip() == heading:
                in_target = True
                out.append(ln)
                continue
              if in_target:
                if ln.startswith('### '):
                  # heading ended; insert before next heading
                  for b in new_bullets:
                    if b not in existing:
                      out.append(b)
                  in_target = False
                  out.append(ln)
                  continue
                if ln.startswith('- '):
                  existing.add(ln)
              out.append(ln)
            if in_target:
              # end of unreleased reached
              for b in new_bullets:
                if b not in existing:
                  out.append(b)
            return out

          for heading, bullets in sections_to_add.items():
            unreleased = inject(unreleased, heading, bullets)

          new_text = '\n'.join(before + unreleased + after) + '\n'
          changelog_path.write_text(new_text, encoding='utf-8')
          PY
          else
          python3 - <<'PY'
          from pathlib import Path

          changelog_path = Path('./GenDemo/CHANGELOG.md')
          text = changelog_path.read_text(encoding='utf-8')

          def read_lines(path: str):
            p = Path(path)
            if not p.exists():
              return []
            return [ln.rstrip('\n') for ln in p.read_text(encoding='utf-8').splitlines() if ln.strip()]

          sections_to_add = {
            '### Added': read_lines('artifacts/added.md'),
            '### Changed': read_lines('artifacts/changed.md'),
            '### Fixed': read_lines('artifacts/fixed.md'),
            '### Breaking Changes': read_lines('artifacts/breaking.md'),
          }

          lines = text.splitlines()
          try:
            start = next(i for i,l in enumerate(lines) if l.strip() == '## [Unreleased]')
          except StopIteration:
            raise SystemExit('Missing "## [Unreleased]" header in CHANGELOG.md')
          end = next((i for i in range(start+1, len(lines)) if lines[i].startswith('## [')), len(lines))

          unreleased = lines[start:end]
          before = lines[:start]
          after = lines[end:]

          def inject(unreleased_lines, heading, new_bullets):
            if not new_bullets:
              return unreleased_lines
            out = []
            in_target = False
            existing = set()
            for ln in unreleased_lines:
              if ln.strip() == heading:
                in_target = True
                out.append(ln)
                continue
              if in_target:
                if ln.startswith('### '):
                  for b in new_bullets:
                    if b not in existing:
                      out.append(b)
                  in_target = False
                  out.append(ln)
                  continue
                if ln.startswith('- '):
                  existing.add(ln)
              out.append(ln)
            if in_target:
              for b in new_bullets:
                if b not in existing:
                  out.append(b)
            return out

          for heading, bullets in sections_to_add.items():
            unreleased = inject(unreleased, heading, bullets)

          new_text = '\n'.join(before + unreleased + after) + '\n'
          changelog_path.write_text(new_text, encoding='utf-8')
          PY
          fi

      - name: Commit and push changelog (main push only)
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ./GenDemo/CHANGELOG.md docs/api/openapi.json docs/api/index.html
          git commit -m "chore: update CHANGELOG.md with latest release notes [skip ci]" || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git push origin HEAD:main

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            artifacts/release-notes.md
            artifacts/commits.txt
            artifacts/added.md
            artifacts/changed.md
            artifacts/fixed.md
            artifacts/breaking.md
            artifacts/CHANGELOG.md
            ./GenDemo/CHANGELOG.md
            docs/api/openapi.json
            docs/api/index.html

      - name: Upload Pages artifact
        if: github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

  deploy-pages:
    if: github.event_name == 'push' && github.actor != 'github-actions[bot]'
    needs: build-release-docs
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
